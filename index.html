<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Multi-room Chat</title>
  <style>
    body { margin: 0; font-family: system-ui, Segoe UI, Arial; background: #0f0f12; color: #eaeaf2; }
    .app { display: grid; grid-template-columns: 240px 1fr; height: 100vh; }
    .sidebar { background: #15151b; border-right: 1px solid #252533; padding: 12px; display: flex; flex-direction: column; gap: 12px; }
    .section { display: flex; flex-direction: column; gap: 6px; }
    input, button, select { background: #1a1a22; color: #eaeaf2; border: 1px solid #272734; border-radius: 8px; padding: 8px 10px; }
    button { cursor: pointer; }
    .rooms { display: flex; flex-direction: column; gap: 6px; max-height: 30vh; overflow-y: auto; }
    .main { display: grid; grid-template-rows: auto 1fr auto; }
    .header { padding: 12px 16px; border-bottom: 1px solid #252533; background: #121217; display: flex; align-items: center; justify-content: space-between; }
    .messages { padding: 12px 16px; overflow-y: auto; display: flex; flex-direction: column; gap: 8px; }
    .msg { max-width: 70%; border: 1px solid #262636; background: #1a1a22; padding: 8px 10px; border-radius: 10px; }
    .meta { font-size: 11px; color: #9aa0a6; margin-bottom: 4px; }
    .composer { display: grid; grid-template-columns: 1fr auto; gap: 10px; padding: 12px 16px; border-top: 1px solid #252533; background: #121217; }
    .system { align-self: center; font-size: 12px; color: #9aa0a6; padding: 6px 10px; border-radius: 999px; border: 1px dashed #272734; background: #15151b; }
  </style>
</head>
<body>
  <div class="app">
    <aside class="sidebar">
      <div class="section">
        <label>Server address</label>
        <input id="server" placeholder="ws://localhost:5001" />
      </div>
      <div class="section">
        <label>Username</label>
        <input id="username" placeholder="Cameron" />
        <button id="connect">Connect</button>
        <button id="disconnect" disabled>Disconnect</button>
      </div>
      <div class="section">
        <label>Join room</label>
        <input id="roomJoin" placeholder="room name (e.g. general)" />
        <input id="roomJoinPwd" placeholder="password (optional)" />
        <button id="join">Join</button>
      </div>
      <div class="section">
        <label>Create room</label>
        <input id="roomCreate" placeholder="new room name" />
        <input id="roomCreatePwd" placeholder="password (optional)" />
        <button id="create">Create</button>
      </div>
      <div class="section">
        <label>Rooms</label>
        <div id="rooms" class="rooms"></div>
        <button id="refreshRooms">Refresh rooms</button>
      </div>
    </aside>

    <main class="main">
      <div class="header">
        <div>Room: <span id="currentRoom">none</span></div>
        <div>Status: <span id="status">disconnected</span></div>
      </div>
      <div id="messages" class="messages"></div>
      <div class="composer">
        <input id="text" placeholder="Type a message..." />
        <button id="send">Send</button>
      </div>
    </main>
  </div>

  <script>
    let ws = null;
    let me = { username: 'Anon', room: null };

    const els = {
      server: document.getElementById('server'),
      username: document.getElementById('username'),
      connect: document.getElementById('connect'),
      disconnect: document.getElementById('disconnect'),
      roomJoin: document.getElementById('roomJoin'),
      roomJoinPwd: document.getElementById('roomJoinPwd'),
      roomCreate: document.getElementById('roomCreate'),
      roomCreatePwd: document.getElementById('roomCreatePwd'),
      join: document.getElementById('join'),
      create: document.getElementById('create'),
      refreshRooms: document.getElementById('refreshRooms'),
      rooms: document.getElementById('rooms'),
      status: document.getElementById('status'),
      currentRoom: document.getElementById('currentRoom'),
      messages: document.getElementById('messages'),
      text: document.getElementById('text'),
      send: document.getElementById('send'),
    };

    function setStatus(text) { els.status.textContent = text; }
    function setRoom(room) { els.currentRoom.textContent = room || 'none'; }
    function addSystem(text) {
      const el = document.createElement('div');
      el.className = 'system';
      el.textContent = text;
      els.messages.appendChild(el);
      els.messages.scrollTop = els.messages.scrollHeight;
    }
    function addMessage({ username, text, ts, room }) {
      const wrap = document.createElement('div');
      wrap.className = 'msg';
      const meta = document.createElement('div');
      meta.className = 'meta';
      meta.textContent = `${username} • ${new Date(ts).toLocaleTimeString()} • #${room}`;
      const body = document.createElement('div');
      body.textContent = text;
      wrap.appendChild(meta);
      wrap.appendChild(body);
      els.messages.appendChild(wrap);
      els.messages.scrollTop = els.messages.scrollHeight;
    }

    function renderRooms(list) {
      els.rooms.innerHTML = '';
      list.forEach((name) => {
        const btn = document.createElement('button');
        btn.textContent = name;
        btn.onclick = () => {
          els.roomJoin.value = name;
          els.roomJoinPwd.value = '';
        };
        els.rooms.appendChild(btn);
      });
    }

    function connect() {
      const url = els.server.value.trim() || 'ws://localhost:5001';
      me.username = els.username.value.trim() || 'Anon';

      try {
        ws = new WebSocket(url);
      } catch (e) {
        setStatus('invalid url');
        return;
      }

      setStatus('connecting...');
      ws.onopen = () => {
        setStatus('connected');
        ws.send(JSON.stringify({ type: 'hello', username: me.username }));
        addSystem(`Connected to ${url} as ${me.username}`);
        els.connect.disabled = true;
        els.disconnect.disabled = false;
      };

      ws.onmessage = (evt) => {
        let packet;
        try { packet = JSON.parse(evt.data); } catch { return; }

        if (packet.type === 'system') {
          addSystem(packet.text);
        } else if (packet.type === 'rooms') {
          renderRooms(packet.rooms);
        } else if (packet.type === 'joined') {
          me.room = packet.room;
          setRoom(me.room);
          addSystem(`Joined "${me.room}"`);
        } else if (packet.type === 'chat') {
          addMessage(packet);
        } else if (packet.type === 'error') {
          addSystem(`Error: ${packet.text}`);
        }
      };

      ws.onclose = () => {
        setStatus('disconnected');
        els.connect.disabled = false;
        els.disconnect.disabled = true;
        addSystem('Disconnected');
      };

      ws.onerror = () => {
        setStatus('error');
        addSystem('Connection error');
      };
    }

    function disconnect() {
      if (ws) {
        ws.close();
        ws = null;
      }
    }

    function joinRoom() {
      if (!ws || ws.readyState !== WebSocket.OPEN) return;
      const room = els.roomJoin.value.trim() || 'general';
      const pwd = els.roomJoinPwd.value.trim();
      ws.send(JSON.stringify({ type: 'join', room, password: pwd }));
    }

    function createRoom() {
      if (!ws || ws.readyState !== WebSocket.OPEN) return;
      const room = els.roomCreate.value.trim() || 'newroom';
      const pwd = els.roomCreatePwd.value.trim();
      ws.send(JSON.stringify({ type: 'create', room, password: pwd }));
    }

    function sendChat() {
      if (!ws || ws.readyState !== WebSocket.OPEN || !me.room) return;
      const text = els.text.value.trim();
      if (!text) return;
      ws.send(JSON.stringify({ type: 'chat', text, room: me.room }));
      els.text.value = '';
    }

    // Event bindings
    els.connect.onclick = connect;
    els.disconnect.onclick = disconnect;
    els.join.onclick = joinRoom;
    els.create.onclick = createRoom;
    els.refreshRooms.onclick = () => {
      if (ws && ws.readyState === WebSocket.OPEN) {
        ws.send(JSON.stringify({ type: 'rooms' }));
      }
    };
    els.send.onclick = sendChat;
    els.text.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') sendChat();
    });
  </script>
</body>
</html>
